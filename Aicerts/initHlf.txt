set -o xtrace    # print commands before execution (good)

# ------------------------------------- Basic checks before running the network ---------------------------------

# Go to the root path only on the local machine , not doing this on the remote server as we may have many files in the root folder which we may accidentally delete
 if [[ -n "${SSH_CONNECTION:-}" ]]; then
        echo "Running on remote server (via SSH)"
    else
        echo "Running locally"
        cd ~
    fi

# Bring down Fabric test network (if exists)
[ -d fabric/fabric-samples/test-network ] && (
  cd fabric/fabric-samples/test-network && ./network.sh down
) || true

# Bring down Hyperledger Explorer (if exists)
[ -d hlf-explorer ] && (
  cd hlf-explorer && docker-compose down
) || true


#----------------------------------------------- Network ---------------------------------------------
rm -rf fabric

mkdir fabric
cd fabric

#Download fabric samples
curl -sSLO https://raw.githubusercontent.com/hyperledger/fabric/main/scripts/install-fabric.sh && chmod +x install-fabric.sh

#Pull the docker containers
./install-fabric.sh docker samples binary --fabric-version 2.5.6

cd fabric-samples/test-network/

./network.sh down

./network.sh up

./network.sh createChannel -c mychannel

# ccn= chain code name , ccp= chain code path , ccl= chaincode langauge , c= channel
./network.sh deployCC -ccn basic -ccp ../asset-transfer-basic/chaincode-go -ccl go -c mychannel

export PATH=${PWD}/../bin:$PATH
export FABRIC_CFG_PATH=$PWD/../config/

#Set the environment variables to operate Peer as Org1
export CORE_PEER_TLS_ENABLED=true
export CORE_PEER_LOCALMSPID=Org1MSP
export CORE_PEER_TLS_ROOTCERT_FILE=${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
export CORE_PEER_MSPCONFIGPATH=${PWD}/organizations/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
export CORE_PEER_ADDRESS=localhost:7051

#Command to initialize the ledger with assets
peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n basic --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"InitLedger","Args":[]}'

#Query the ledger
peer chaincode query -C mychannel -n basic -c '{"Args":["GetAllAssets"]}'

#Transfer the asset
peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile "${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem" -C mychannel -n basic --peerAddresses localhost:7051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt" --peerAddresses localhost:9051 --tlsRootCertFiles "${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt" -c '{"function":"TransferAsset","Args":["asset6","Christopher"]}'

#Query the ledger
peer chaincode query -C mychannel -n basic -c '{"Args":["GetAllAssets"]}'

set +x
#------------------------------------------------------ Explorer ----------------------------------------------------------
cd ../../

mkdir hlf-explorer
cd hlf-explorer

wget https://raw.githubusercontent.com/hyperledger/blockchain-explorer/main/examples/net1/config.json
wget https://raw.githubusercontent.com/hyperledger/blockchain-explorer/main/examples/net1/connection-profile/test-network.json -P connection-profile
wget https://raw.githubusercontent.com/hyperledger/blockchain-explorer/main/docker-compose.yaml

cp -r ../fabric-samples/test-network/organizations .

export EXPLORER_CONFIG_FILE_PATH=./config.json
export EXPLORER_PROFILE_DIR_PATH=./connection-profile
export FABRIC_CRYPTO_PATH=./organizations

docker-compose down -v

# TODO : we need to set external = true
docker-compose up -d

--------------------------------------------------------- AFTER SETUP COMMANDS ----------------------------------------------------

set o
